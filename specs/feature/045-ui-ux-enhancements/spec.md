# Feature Specification: UI/UX Enhancements (Phase 3.5)

**Feature Branch**: `045-ui-ux-enhancements`
**Created**: 2026-01-28
**Status**: Draft
**Input**: Phase 3.5 UI/UX improvements based on Issues #51, #52, #53, #55

## Overview

kaiu のユーザーインターフェースを強化し、マウス操作のサポートと視覚的なフィードバックを改善する。Vim キーバインドに加えて、マウスでも直感的に操作できるようにする。

## Related Issues

- #51: マウスクリックでカーソル移動 - クリックでファイルツリーのカーソルを移動
- #52: ダブルクリックでディレクトリ展開/ファイルプレビュー - ダブルクリックで操作
- #55: ステータスバーにファイル情報を表示 - ファイルサイズ、更新日時など
- #53: Nerd Font アイコン対応 - ファイル種別をアイコンで表示

## User Scenarios & Testing

### User Story 1 - マウスクリックでカーソル移動 (Priority: P1)

ユーザーはファイルツリー内の任意のファイルやディレクトリをマウスでクリックして、カーソルを即座に移動できる。キーボード操作に慣れていないユーザーでも直感的に操作できる。

**Why this priority**: 他のマウス操作（ダブルクリック）の基盤となる機能。マウス操作の入り口として最も重要。

**Independent Test**: ファイルツリーの任意の行をクリックし、カーソルがその行に移動することを確認。

**Acceptance Scenarios**:

1. **Given** ファイルツリーが表示されている, **When** ユーザーが任意の行を左クリック, **Then** カーソルがその行に移動する
2. **Given** スクロールして画面外のファイルがある, **When** 表示されている行をクリック, **Then** クリックした行にカーソルが移動する
3. **Given** カーソルが 10 行目にある, **When** 5 行目をクリック, **Then** カーソルが 5 行目に移動する
4. **Given** ファイルツリー領域外（ステータスバーなど）, **When** クリック, **Then** 何も起こらない（カーソルは変わらない）

---

### User Story 2 - ダブルクリックで展開/プレビュー (Priority: P2)

ユーザーはディレクトリをダブルクリックして展開/折りたたみ、ファイルをダブルクリックしてプレビューを表示できる。GUI ファイルマネージャーと同様の操作感を提供。

**Why this priority**: P1 のマウスクリック機能に依存。直感的な操作の完成度を高める。

**Independent Test**: ディレクトリをダブルクリックして展開し、ファイルをダブルクリックしてプレビューが開くことを確認。

**Acceptance Scenarios**:

1. **Given** 折りたたまれたディレクトリがある, **When** ダブルクリック, **Then** ディレクトリが展開される
2. **Given** 展開されたディレクトリがある, **When** ダブルクリック, **Then** ディレクトリが折りたたまれる
3. **Given** ファイルがある, **When** ダブルクリック, **Then** プレビューモードが開く
4. **Given** 1 回目のクリック後, **When** 閾値時間（400ms）以内に同じ行を再クリック, **Then** ダブルクリックとして処理される
5. **Given** 1 回目のクリック後, **When** 閾値時間を超えて再クリック, **Then** 2 回の単独クリックとして処理される

---

### User Story 3 - ステータスバーにファイル情報表示 (Priority: P2)

ユーザーは選択中のファイルの情報（名前、サイズ、更新日時）をステータスバーで即座に確認できる。ファイルの詳細を知るためにプレビューを開く必要がない。

**Why this priority**: マウス操作とは独立して実装可能。日常的に有用な情報を提供。

**Independent Test**: ファイルを選択し、ステータスバーにファイル名、サイズ、更新日時が表示されることを確認。

**Acceptance Scenarios**:

1. **Given** ファイルが選択されている, **When** ステータスバーを見る, **Then** ファイル名、サイズ、更新日時が表示される
2. **Given** ディレクトリが選択されている, **When** ステータスバーを見る, **Then** ディレクトリ名とアイテム数が表示される
3. **Given** 1.5KB のファイルが選択されている, **When** サイズを確認, **Then** "1.5K" のように人間が読みやすい形式で表示される
4. **Given** 5 分前に更新されたファイル, **When** 更新日時を確認, **Then** "5 min ago" のように相対時間で表示される
5. **Given** 昨年更新されたファイル, **When** 更新日時を確認, **Then** "Jan 20 2025" のように日付で表示される

---

### User Story 4 - Nerd Font アイコン表示 (Priority: P3)

ユーザーはファイルツリーで Nerd Font アイコンを見て、ファイルの種類を一目で判別できる。視覚的な情報量が増え、目的のファイルを素早く見つけられる。

**Why this priority**: 見た目の改善。機能的な価値は低いが、UX を向上させる。Nerd Font 未インストール環境への配慮も必要。

**Independent Test**: Nerd Font がインストールされた環境で kaiu を起動し、ファイル種別に応じたアイコンが表示されることを確認。

**Acceptance Scenarios**:

1. **Given** Nerd Font がインストールされている, **When** .zig ファイルを見る, **Then** Zig アイコンが表示される
2. **Given** 折りたたまれたディレクトリ, **When** ツリーを見る, **Then** 閉じたフォルダアイコンが表示される
3. **Given** 展開されたディレクトリ, **When** ツリーを見る, **Then** 開いたフォルダアイコンが表示される
4. **Given** 未知の拡張子のファイル, **When** ツリーを見る, **Then** デフォルトのファイルアイコンが表示される
5. **Given** `--no-icons` フラグ付きで起動, **When** ツリーを見る, **Then** アイコンなしで表示される（従来と同じ）

---

### Edge Cases

- マウスイベントが高速で連続した場合（ドラッグ操作との区別）
- ターミナルウィンドウのリサイズ中のクリック
- 空のディレクトリのダブルクリック → 展開してもエントリなし（正常動作）
- シンボリックリンクのダブルクリック → リンク先に応じて展開/プレビュー
- 壊れたシンボリックリンク → ステータスバーに "-" を表示、ダブルクリックはステータスバーに "Cannot open: broken symlink" を表示
- 非常に長いファイル名のステータスバー表示（切り詰め処理）
- Nerd Font 未インストール環境 → `--no-icons` フラグで無効化（自動検出なし）
- 特殊ファイル（Makefile, .gitignore など）のアイコンマッピング
- 空のツリー（ディレクトリが空）→ ステータスバーはパスのみ表示、ヘルプヒントは維持
- ツリー内の空白行（最後のエントリより下）をクリック → 何も起こらない（カーソルは変わらない）
- stat 失敗時（パーミッションエラー）→ サイズ/日時に "-" を表示

## Requirements

### Functional Requirements

**マウスクリック (US1)**
- **FR-001**: 左クリックでクリックした行にカーソルを移動する
- **FR-002**: クリック位置（画面行）からツリーの可視インデックスを計算する
- **FR-003**: ファイルツリー領域外のクリックは無視する
- **FR-004**: ツリー内の空白行（最後のエントリより下）のクリックは無視する

**ダブルクリック (US2)**
- **FR-010**: ダブルクリックを時間閾値（400ms）で検出する
- **FR-014**: 壊れたシンボリックリンクのダブルクリックはステータスバーにエラーメッセージを表示する
- **FR-011**: ディレクトリのダブルクリックで展開/折りたたみをトグルする
- **FR-012**: ファイルのダブルクリックでプレビューモードを開く
- **FR-013**: ダブルクリック検出には同一エントリのクリックであることを確認する

**ステータスバー (US3)**
- **FR-020**: ファイル選択時にファイル名、サイズ、更新日時を表示する
- **FR-021**: ディレクトリ選択時にディレクトリ名とアイテム数を表示する
- **FR-022**: サイズを人間が読みやすい形式で表示する（B, K, M, G）
- **FR-023**: 更新日時を相対時間で表示する（just now, 5 min ago, yesterday など）
- **FR-024**: 古い更新日時は絶対日付で表示する（英語フォーマット固定: Jan 20, Jan 20 2025）
- **FR-025**: ヘルプヒント `?:help` は常に表示する（空ツリー時も含む）
- **FR-026**: stat 失敗時はサイズ/日時に "-" を表示する
- **FR-027**: 空のツリーまたはカーソルがエントリ上にない場合、ファイル情報部分はパスのみ表示する（ヘルプヒントは維持）
- **FR-028**: 相対時間は 30 日以内、それ以降は絶対日付で表示する

**Nerd Font アイコン (US4)**
- **FR-030**: 拡張子に応じたアイコンを表示する
- **FR-031**: ディレクトリは展開状態に応じてアイコンを切り替える
- **FR-032**: 特殊ファイル名（Makefile, .gitignore など）に対応する
- **FR-033**: `--no-icons` フラグでアイコン表示を無効化できる（自動検出なし、明示的オプトアウトのみ）
- **FR-034**: 未知の拡張子にはデフォルトアイコンを表示する
- **FR-035**: アイコン幅はセル幅計測を使用する（固定幅仮定しない）

### Key Entities

- **MouseEvent**: クリック位置（row, column）、クリック種別（left, right）、タイムスタンプ
- **FileInfo**: ファイル名、サイズ（バイト）、更新日時（タイムスタンプ）
- **IconMapping**: 拡張子/ファイル名パターン → Nerd Font Unicode コードポイント

## Success Criteria

### Measurable Outcomes

- **SC-001**: マウスクリックからカーソル移動まで体感即座に反応する（ブロッキング I/O なし）
- **SC-002**: ダブルクリック検出が正確に動作する（時間閾値とエントリ一致による誤検出防止）
- **SC-003**: ステータスバーの情報更新がカーソル移動と同期する（遅延なし）
- **SC-004**: 主要なファイル形式（20 種類以上: zig, md, json, toml, py, js, ts, rs, go, c, cpp, h, html, css, sh, yml, xml, txt, gitignore, Makefile など）のアイコンをサポートする
- **SC-005**: `--no-icons` フラグで従来と同じ表示に戻せる

## Out of Scope

- 右クリックコンテキストメニュー（将来の機能）
- マウスドラッグによる複数選択
- カスタムアイコンテーマのサポート
- 設定ファイルによるアイコンの有効/無効切り替え（フラグのみ）
- プレビューモードでのマウスクリック操作（将来の機能）
- Nerd Font 未インストール時の自動検出・フォールバック

## Assumptions

- libvaxis の mouse_event は正常に動作する（Phase 3 で wheel は動作確認済み）
- Nerd Font のユニコードコードポイントは安定している
- ターミナルエミュレータがマウスイベントをサポートしている（Ghostty, Kitty, WezTerm など）
