# Feature Specification: Phase 4.0 - Symbol Reference Graph

**Feature Branch**: `060-symbol-reference-graph`
**Created**: 2026-01-30
**Status**: Draft
**Input**: Phase 4.0 - シンボルの呼び出し関係をプレビューに表示。言語サーバーを使用してシンボルの呼び出し階層をグラフとして可視化。

## Target Persona

**田中さん (Phase 1-3.5 から継続)**
- Phase 3.5 までで kaiu の基本操作、ファイル操作、VCS 統合、マウス操作に慣れた
- Claude Code でコードを生成しながら開発中
- 生成されたコードの「この関数がどこから呼ばれているか」「この構造体がどこで使われているか」を把握したい
- VSCode の「Go to References」「Find All References」に相当する機能がターミナルでも欲しい
- コードの全体像を視覚的に把握し、影響範囲を理解してからリファクタリングしたい

---

## Related Issues

- #60: feat: シンボル参照グラフをプレビューに表示

---

## User Scenarios & Testing

### User Story 1 - シンボル参照の検索と一覧表示 (Priority: P1)

田中さんは Claude Code で生成された `processFile` 関数をリファクタリングしようとしている。「この関数はどこから呼ばれているのか？」を知りたい。kaiu で関数名にカーソルを置いて参照を検索すると、プロジェクト内のすべての呼び出し箇所が一覧表示される。

**Why this priority**: コード理解の基本機能。参照箇所が分からないとリファクタリングの影響範囲を把握できない。グラフ表示より先に一覧表示が必要。

**Independent Test**: Zig ファイルで関数名にカーソルを置き、参照検索を実行。プロジェクト内の呼び出し箇所がリスト表示されることを確認。

**Acceptance Scenarios**:

1. **Given** プレビューモードで Zig ファイルを表示中、関数定義にカーソルがある, **When** ユーザーが `gr` (go to references) を押す, **Then** その関数を呼び出している箇所が一覧表示される
2. **Given** 参照一覧が表示されている, **When** ユーザーが `j`/`k` で移動, **Then** カーソルが参照箇所間を移動する
3. **Given** 参照一覧で特定の箇所を選択, **When** ユーザーが `Enter` を押す, **Then** その箇所が $EDITOR で開かれる
4. **Given** 参照一覧が表示されている, **When** ユーザーが `o` を押す, **Then** 選択中の参照箇所のコードスニペットがプレビュー表示される
5. **Given** シンボルに参照がない, **When** 参照検索を実行, **Then** 「No references found」と表示される
6. **Given** 言語サーバーが利用できない, **When** 参照検索を実行, **Then** 「Language server not available」と表示される

---

### User Story 2 - 参照グラフの可視化 (Priority: P2)

田中さんは複数のモジュール間の依存関係を把握したい。一覧だけでなく、関数の呼び出し関係をグラフとして視覚的に見たい。参照グラフを表示すると、呼び出し元と呼び出し先がノードとエッジで表現され、コードの構造が一目で分かる。

**Why this priority**: US1 の一覧表示を拡張した高度な可視化機能。一覧表示が基盤として必要。

**Independent Test**: 参照一覧から「グラフ表示」に切り替え、ノードとエッジでシンボルの関係が表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 参照一覧が表示されている, **When** ユーザーが `G` を押す, **Then** グラフ表示モードに切り替わる
2. **Given** グラフが表示されている, **When** ノードを確認, **Then** 各ノードにファイル名、行番号、コードスニペット (±3行) が表示される
3. **Given** グラフが表示されている, **When** ユーザーが `j`/`k` でノードを移動, **Then** 選択ノードがハイライトされる
4. **Given** グラフでノードを選択, **When** ユーザーが `Enter` を押す, **Then** そのファイルの該当行が $EDITOR で開かれる
5. **Given** グラフが表示されている, **When** ユーザーが `l` を押す, **Then** リスト表示モードに戻る
6. **Given** ターミナルがグラフィック表示に対応していない、または外部グラフ描画ツールがない, **When** グラフ表示を試みる, **Then** テキストベースのツリー表示にフォールバック

---

### User Story 3 - 参照のフィルタリング (Priority: P3)

田中さんは大きなプロジェクトで作業しており、参照が数十箇所ある。テストファイルを除外したい、または特定のディレクトリ内の参照だけを見たい。フィルタ機能で絞り込みができる。

**Why this priority**: 大規模プロジェクトでの使い勝手向上。基本機能 (US1, US2) の後に実装。

**Independent Test**: 参照一覧でフィルタを適用し、条件に合う参照のみが表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 参照一覧またはグラフが表示されている, **When** ユーザーが `f` を押す, **Then** フィルタ入力モードになる
2. **Given** フィルタ入力モード, **When** `src/**` と入力して Enter, **Then** src/ 配下の参照のみが表示される
3. **Given** フィルタ入力モード, **When** `!*_test.zig` と入力, **Then** テストファイルが除外される
4. **Given** フィルタが適用されている, **When** ユーザーが `Esc` を押す, **Then** フィルタがクリアされ全参照が表示される
5. **Given** フィルタ適用後, **When** マッチする参照がない, **Then** 「No matches for filter」と表示される

---

### Edge Cases

- シンボルがプライベート (ファイル内のみ使用) の場合: 同一ファイル内の参照のみ表示
- 循環参照がある場合: グラフに循環を表示 (無限ループしない)
- 参照が 100 箇所以上ある場合: ページネーションまたはスクロールで対応
- バイナリファイルや非 Zig ファイルでの実行: 「Unsupported file type」と表示
- LSP がタイムアウトした場合: 「Request timed out」と表示し、再試行オプション
- 複数のシンボルが同じ行にある場合: カーソル位置に最も近いシンボルを選択

---

## Requirements

### Functional Requirements

**シンボル参照検索 (US1)**
- **FR-001**: プレビューモードで `gr` キーを押すと、カーソル位置のシンボルの参照を検索する
- **FR-002**: 参照結果をファイル名、行番号、コードスニペットと共に一覧表示する
- **FR-003**: 参照一覧で `j`/`k` による移動、`Enter` で $EDITOR を開く
- **FR-004**: 参照一覧で `o` を押すとコードスニペットのプレビューを表示する
- **FR-005**: 参照がない場合は「No references found」を表示する
- **FR-006**: 言語サーバーが利用できない場合は「Language server not available」を表示する

**グラフ表示 (US2)**
- **FR-010**: 参照一覧で `G` を押すとグラフ表示モードに切り替わる
- **FR-011**: グラフのノードにファイル名、行番号、コードスニペット (±3行) を表示する
- **FR-012**: グラフのエッジで呼び出し階層 (呼び出し元 → 呼び出し先) を表現する
- **FR-013**: グラフィック非対応ターミナル、または外部グラフ描画ツールがない場合はテキストベースのツリー表示にフォールバックする
- **FR-014**: グラフで `l` を押すとリスト表示に戻る

**フィルタリング (US3)**
- **FR-020**: 参照一覧/グラフで `f` を押すとフィルタ入力モードになる
- **FR-021**: glob パターンでファイルパスをフィルタできる (例: `src/**`, `!*_test.zig`)
- **FR-022**: `Esc` でフィルタをクリアする
- **FR-023**: フィルタ適用中はステータスバーにフィルタ条件を表示する

**言語サーバー連携**
- **FR-030**: 言語サーバーを外部プロセスとして起動し通信する
- **FR-031**: 言語サーバーのリクエストでシンボル参照と呼び出し階層を取得する
- **FR-032**: 言語サーバー起動失敗、タイムアウト時はユーザーフレンドリーなエラーメッセージを表示する
- **FR-033**: 言語サーバープロセスのライフサイクルを適切に管理する (起動、再起動、終了)

### Key Entities

- **SymbolReference**: 参照箇所 (ファイルパス、行番号、列番号、コードスニペット)
- **CallHierarchyGraph**: シンボルの呼び出し階層を表すグラフ構造 (ノード: シンボル、エッジ: 呼び出し関係)
- **LanguageServerClient**: 言語サーバーとの通信を管理するクライアント

---

## Success Criteria

### Measurable Outcomes

- **SC-001**: ユーザーは 2 キー操作 (シンボル選択 + `gr`) でシンボル参照を検索できる
- **SC-002**: 参照検索結果は 3 秒以内に表示される (中規模プロジェクト: 100 ファイル程度)
- **SC-003**: グラフ表示は参照数 50 以下で 2 秒以内にレンダリングされる
- **SC-004**: 言語サーバー未インストール時もアプリがクラッシュせず、適切なエラーメッセージを表示する
- **SC-005**: グラフィック非対応ターミナルまたは外部ツール未インストール時もテキストフォールバックで参照を確認できる

---

## Out of Scope

- Zig 以外の言語サポート (将来の拡張として検討)
- シンボルの定義へのジャンプ (`gd` = go to definition) - 別機能として検討
- インライン補完や自動インポート (IDE 機能)
- 言語サーバー設定のカスタマイズ
- 複数言語の同時対応
- TreeView モードからの参照検索 (プレビューモードのみサポート)

---

## Assumptions

- ユーザーは Zig プロジェクトで作業している
- Zig 言語サーバー (zls) がインストールされている (または利用可能、未インストール時は graceful degradation)
- 外部グラフ描画ツール (Graphviz 等) は任意 (未インストール時はテキストフォールバック)
- ターミナルは画像表示プロトコルをサポートしている (フォールバックあり)
- $EDITOR 環境変数が設定されている (未設定時はデフォルトエディタを使用)
- `gr` キーはプレビューモードからのみ実行可能
